# ===== Starter pipeline (ETES Secured Edition) =====
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - APP/*
      - api/* # تعديل: عشان يحس بأي تغيير في كود الـ API
      - azure-pipelines.yml 
      - "*.tf"              
    exclude:
      - Infrastructure/* - README.md

pool:
  name: 'Default'  # Self-hosted agent

variables:
  serviceConnection: 'Fabrikam-Manual-SP'
  storageRG: 'Terraform-Management-RG'
  storageAccount: 'fabtfstate2026'
  container: 'tfstate'
  tfstateKey: 'prod.terraform.tfstate'
  # ملاحظة: تأكد من وجود سر باسم deployment_token في الـ Library/Variables

stages:

# --------- 1) Terraform Plan ----------
- stage: Terraform_Plan
  displayName: 'Plan Stage'
  condition: and(succeeded(), or(eq(variables['Build.Reason'], 'Manual'), contains(variables['Build.SourceVersionMessage'], '[infra]')))
  jobs:
  - job: Plan
    displayName: 'Terraform Plan'
    steps:
    - task: TerraformTaskV4@4
      displayName: 'Terraform Init'
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: '$(serviceConnection)'
        backendAzureRmResourceGroupName: '$(storageRG)'
        backendAzureRmStorageAccountName: '$(storageAccount)'
        backendAzureRmContainerName: '$(container)'
        backendAzureRmKey: '$(tfstateKey)'
        workingDirectory: '$(System.DefaultWorkingDirectory)'
    - powershell: |
        terraform import azurerm_static_site.web_app /subscriptions/30d80e3c-9c7b-490c-aaba-8a022a405d1e/resourceGroups/Fabricam-Project-prod-rg/providers/Microsoft.Web/staticSites/Fabricam-Project-static-webapp
      displayName: 'Fix State Link'
      continueOnError: true # مهمة عشان لو اتربط قبل كدة ميعطلش البايبلاين
      workingDirectory: '$(System.DefaultWorkingDirectory)'

    - task: TerraformTaskV4@4
      displayName: 'Terraform Plan'
      inputs:
        provider: 'azurerm'
        command: 'plan'
        environmentServiceNameAzureRM: '$(serviceConnection)'
        workingDirectory: '$(System.DefaultWorkingDirectory)'

# --------- 2) Terraform Apply ----------
- stage: Terraform_Apply
  displayName: 'Execution Stage'
  dependsOn: Terraform_Plan
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - job: Apply
    displayName: 'Terraform Apply'
    steps:
    - task: TerraformTaskV4@4
      displayName: 'Terraform Init'
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: '$(serviceConnection)'
        backendAzureRmResourceGroupName: '$(storageRG)'
        backendAzureRmStorageAccountName: '$(storageAccount)'
        backendAzureRmContainerName: '$(container)'
        backendAzureRmKey: '$(tfstateKey)'
        workingDirectory: '$(System.DefaultWorkingDirectory)'

    - task: TerraformTaskV4@4
      displayName: 'Terraform Apply'
      inputs:
        provider: 'azurerm'
        command: 'apply'
        environmentServiceNameAzureRM: '$(serviceConnection)'
        workingDirectory: '$(System.DefaultWorkingDirectory)'

# --------- 3) Deploy Static Web App ----------
- stage: SWA_Deploy
  displayName: 'Deploy Static Web App'
  dependsOn: Terraform_Apply # تعديل: يفضل يعتمد على الـ Apply لضمان وجود الـ Resources
  condition: succeeded()
  pool:
    name: 'Default'

  jobs:
  - job: DeploySWA
    displayName: 'Publish to Azure Static Web Apps'
    steps:
    - checkout: self

    - task: NodeTool@0
      displayName: 'Use Node.js 20.x'
      inputs:
        versionSpec: '20.x'

    - powershell: |
        npm install -g @azure/static-web-apps-cli@^2
      displayName: 'Install SWA CLI'

    # الخطوة السحرية: ربط الـ App مع الـ API في الـ Deploy
    - powershell: |
        $ErrorActionPreference = 'Stop'
        $app_src = "$(System.DefaultWorkingDirectory)\APP"
        $api_src = "$(System.DefaultWorkingDirectory)\api"
        
        Write-Host "Deploying App from: $app_src"
        Write-Host "Deploying API from: $api_src"
        
        # أمر النشر مع تحديد مكان الـ API
        swa deploy "$app_src" --api-location "$api_src" --env production --deployment-token "$(deployment_token)"
      displayName: 'SWA Deploy (App + API)'