# ===== Starter pipeline (معدّل) =====
trigger:
- main

pool:
  name: 'Default'  # Self-hosted agent (عندك)

variables:
  serviceConnection: 'Fabrikam-Manual-SP'
  storageRG: 'Terraform-Management-RG'
  storageAccount: 'fabtfstate2026'
  container: 'tfstate'
  tfstateKey: 'prod.terraform.tfstate'
  # أضف متغير secret باسم deployment_token من UI

stages:

# --------- 1) Terraform Plan ----------
- stage: Terraform_Plan
  displayName: 'Plan Stage'
  jobs:
  - job: Plan
    displayName: 'Terraform Plan'
    steps:
    # (A) init أولاً عشان backend يبقى مهيّأ قبل force-unlock
    - task: TerraformTaskV4@4
      displayName: 'Terraform Init (pre-unlock)'
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: '$(serviceConnection)'
        backendAzureRmResourceGroupName: '$(storageRG)'
        backendAzureRmStorageAccountName: '$(storageAccount)'
        backendAzureRmContainerName: '$(container)'
        backendAzureRmKey: '$(tfstateKey)'
        workingDirectory: '$(System.DefaultWorkingDirectory)'

     
    - task: TerraformTaskV4@4
      displayName: 'Terraform Init (plan)'
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: '$(serviceConnection)'
        backendAzureRmResourceGroupName: '$(storageRG)'
        backendAzureRmStorageAccountName: '$(storageAccount)'
        backendAzureRmContainerName: '$(container)'
        backendAzureRmKey: '$(tfstateKey)'
        workingDirectory: '$(System.DefaultWorkingDirectory)'

    # (D) Plan
    - task: TerraformTaskV4@4
      displayName: 'Terraform Plan'
      inputs:
        provider: 'azurerm'
        command: 'plan'
        environmentServiceNameAzureRM: '$(serviceConnection)'
        workingDirectory: '$(System.DefaultWorkingDirectory)'

# --------- 2) Terraform Apply ----------
- stage: Terraform_Apply
  displayName: 'Execution Stage'
  dependsOn: Terraform_Plan
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - job: Apply
    displayName: 'Terraform Apply'
    steps:
    - task: TerraformTaskV4@4
      displayName: 'Terraform Init (apply)'
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: '$(serviceConnection)'
        backendAzureRmResourceGroupName: '$(storageRG)'
        backendAzureRmStorageAccountName: '$(storageAccount)'
        backendAzureRmContainerName: '$(container)'
        backendAzureRmKey: '$(tfstateKey)'
        workingDirectory: '$(System.DefaultWorkingDirectory)'

    - task: TerraformTaskV4@4
      displayName: 'Terraform Apply'
      inputs:
        provider: 'azurerm'
        command: 'apply'
        environmentServiceNameAzureRM: '$(serviceConnection)'
        workingDirectory: '$(System.DefaultWorkingDirectory)'




# --------- 3) Deploy Static Web App ----------
- stage: SWA_Deploy
  displayName: 'Deploy Static Web App'
  dependsOn: Terraform_Apply
  condition: succeeded()
  pool:
    name: 'Default'    # self-hosted Windows agent

  jobs:
  - job: DeploySWA
    displayName: 'Publish to Azure Static Web Apps'
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: 'Deploy to SWA via Azure CLI (PowerShell, clean install ext)'
      inputs:
        azureSubscription: '$(serviceConnection)'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          Write-Host "Azure CLI version:"; az version

          $swaName = "Fabricam-Project-static-webapp"        # ← اسم SWA
          $swaRg   = " Fabricam-Project-prod-rg"          # ← Resource Group
          $srcPath = "$(System.DefaultWorkingDirectory)\APP"
          $token   = "$(deployment_token)"

          # 1) إزالة أي نسخة للإضافة (لو موجودة) لتفادي اللخبطة
          try {
            Write-Host "Removing 'staticwebapp' extension if present..."
            az extension remove --name staticwebapp
          } catch {
            Write-Warning "Remove extension failed or not installed; continuing..."
          }

          # 2) تثبيت الإضافة من الصفر
          Write-Host "Adding 'staticwebapp' extension cleanly..."
          az extension add --name staticwebapp
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Failed to add 'staticwebapp' extension."
            exit 1
          }

          # 3) تحقّق أن الإضافة اتثبتت فعلاً
          $extOk = $false
          try {
            $out = az extension list --output tsv --query "[?name=='staticwebapp'].name"
            if ($out -match "staticwebapp") { $extOk = $true }
          } catch {
            $extOk = $false
          }
          if (-not $extOk) {
            Write-Error "'staticwebapp' extension not loaded; cannot proceed."
            exit 1
          }

          # 4) نشر محتوى مجلد APP
          Write-Host "Uploading to SWA: $swaName in RG: $swaRg from: $srcPath"
          az staticwebapp upload `
            --name $swaName `
            --resource-group $swaRg `
            --source $srcPath `
            --token $token

          if ($LASTEXITCODE -ne 0) {
            Write-Error "SWA upload failed."
            exit 1
          } else {
            Write-Host "SWA upload completed successfully."
          }