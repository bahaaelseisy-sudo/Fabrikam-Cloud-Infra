# ===== Starter pipeline (معدّل) =====
trigger:
- main

# لو بتستخدم self-hosted agent:
pool:
  name: 'Default'
# لو تحب Microsoft-hosted بدل الذاتي، بدّل للسطرين دول:
# pool:
#   vmImage: 'ubuntu-latest'

variables:
  serviceConnection: 'Fabrikam-Manual-SP'
  storageRG: 'Terraform-Management-RG'
  storageAccount: 'fabtfstate2026'
  container: 'tfstate'
  tfstateKey: 'prod.terraform.tfstate'
  # NOTE: أضف deployment_token من UI كمتغير سري (Variables) ولا تكتبه هنا.

stages:

# --------- 1) Terraform Plan ----------
- stage: Terraform_Plan
  displayName: 'Plan Stage'
  jobs:
  - job: Plan
    displayName: 'Terraform Plan'
    steps:
    # (مرة واحدة فقط) Force unlock قبل init — احذفها بعد نجاح أول ران
    - task: TerraformTaskV4@4
      displayName: 'Force unlock state (one-off)'
      inputs:
        provider: 'azurerm'
        command: 'custom'
        customCommand: 'force-unlock'
        customCommandOptions: '-force b3e2b1a4-da43-312c-86aa-d14fc70fd588'
        # ملفات Terraform عندك في جذر الريبو
        workingDirectory: '$(System.DefaultWorkingDirectory)'
        environmentServiceNameAzureRM: '$(serviceConnection)'

    - task: TerraformTaskV4@4
      displayName: 'Terraform Init (plan)'
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: '$(serviceConnection)'
        backendAzureRmResourceGroupName: '$(storageRG)'
        backendAzureRmStorageAccountName: '$(storageAccount)'
        backendAzureRmContainerName: '$(container)'
        backendAzureRmKey: '$(tfstateKey)'
        workingDirectory: '$(System.DefaultWorkingDirectory)'

    - task: TerraformTaskV4@4
      displayName: 'Terraform Plan'
      inputs:
        provider: 'azurerm'
        command: 'plan'
        environmentServiceNameAzureRM: '$(serviceConnection)'
        workingDirectory: '$(System.DefaultWorkingDirectory)'

# --------- 2) Terraform Apply ----------
- stage: Terraform_Apply
  displayName: 'Execution Stage'
  dependsOn: Terraform_Plan
  # الـ Apply يشتغل فقط لو الـ Plan نجح وعلى فرع main
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - job: Apply
    displayName: 'Terraform Apply'
    steps:
    - task: TerraformTaskV4@4
      displayName: 'Terraform Init (apply)'
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: '$(serviceConnection)'
        backendAzureRmResourceGroupName: '$(storageRG)'
        backendAzureRmStorageAccountName: '$(storageAccount)'
        backendAzureRmContainerName: '$(container)'
        backendAzureRmKey: '$(tfstateKey)'
        workingDirectory: '$(System.DefaultWorkingDirectory)'

    - task: TerraformTaskV4@4
      displayName: 'Terraform Apply'
      inputs:
        provider: 'azurerm'
        command: 'apply'
        environmentServiceNameAzureRM: '$(serviceConnection)'
        workingDirectory: '$(System.DefaultWorkingDirectory)'

# --------- 3) Deploy Static Web App ----------
- stage: SWA_Deploy
  displayName: 'Deploy Static Web App'
  dependsOn: Terraform_Apply
  condition: succeeded()
  jobs:
  - job: DeploySWA
    displayName: 'Publish to Azure Static Web Apps'
    steps:
    - checkout: self
    - task: AzureStaticWebApp@0
      displayName: 'Deploy Static Web App'
      inputs:
        azure_static_web_apps_api_token: '$(deployment_token)'  # من Variables كـ Secret
        app_location: 'APP'     # مكان index.html و staticwebapp.config.json
        output_location: ''     # مشروع static (بدون build)
        # api_location: ''      # لو أضفت Functions لاحقاً